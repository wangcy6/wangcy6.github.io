<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>IOçš„ä¸€ç”Ÿ - Troyçš„ç½‘ç»œåšå®¢</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Troy" /><meta name="description" content="å¤§å®¶å¥½æˆ‘æ˜¯å°ä¹‰åŒå­¦ï¼Œè¿™æ˜¯å¤§å‚é¢è¯•æ‹†è§£â€”â€”é¡¹ç›®å®æˆ˜ç³»åˆ—çš„ç¬¬6ç¯‡æ–‡ç« ï¼Œ â€èµ°æš—è·¯ã€è€•ç˜¦ç”°ã€è¿›çª„é—¨ã€è§å¾®å…‰â€ å‘Šè¯‰æˆ‘ é¢è¯•å…³é”®å°± æ·±å…¥ç†è§£è‡ªå·±é¡¹ç›® è¿™ä¸ªæ‰æ˜¯" /><meta name="keywords" content="daily-interview-question, Github, c&#43;&#43;, Leetcode é¢˜è§£, åç«¯é¢è¯•" />






<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://wangcy6.github.io/post/storage/2025/2025-05-02-what-is-io-1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="IOçš„ä¸€ç”Ÿ" />
<meta property="og:description" content="å¤§å®¶å¥½æˆ‘æ˜¯å°ä¹‰åŒå­¦ï¼Œè¿™æ˜¯å¤§å‚é¢è¯•æ‹†è§£â€”â€”é¡¹ç›®å®æˆ˜ç³»åˆ—çš„ç¬¬6ç¯‡æ–‡ç« ï¼Œ â€èµ°æš—è·¯ã€è€•ç˜¦ç”°ã€è¿›çª„é—¨ã€è§å¾®å…‰â€ å‘Šè¯‰æˆ‘ é¢è¯•å…³é”®å°± æ·±å…¥ç†è§£è‡ªå·±é¡¹ç›® è¿™ä¸ªæ‰æ˜¯" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wangcy6.github.io/post/storage/2025/2025-05-02-what-is-io-1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2025-04-27T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2025-04-27T00:00:00&#43;00:00" />

<meta itemprop="name" content="IOçš„ä¸€ç”Ÿ">
<meta itemprop="description" content="å¤§å®¶å¥½æˆ‘æ˜¯å°ä¹‰åŒå­¦ï¼Œè¿™æ˜¯å¤§å‚é¢è¯•æ‹†è§£â€”â€”é¡¹ç›®å®æˆ˜ç³»åˆ—çš„ç¬¬6ç¯‡æ–‡ç« ï¼Œ â€èµ°æš—è·¯ã€è€•ç˜¦ç”°ã€è¿›çª„é—¨ã€è§å¾®å…‰â€ å‘Šè¯‰æˆ‘ é¢è¯•å…³é”®å°± æ·±å…¥ç†è§£è‡ªå·±é¡¹ç›® è¿™ä¸ªæ‰æ˜¯"><meta itemprop="datePublished" content="2025-04-27T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2025-04-27T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="4262">
<meta itemprop="keywords" content="CEPH," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="IOçš„ä¸€ç”Ÿ"/>
<meta name="twitter:description" content="å¤§å®¶å¥½æˆ‘æ˜¯å°ä¹‰åŒå­¦ï¼Œè¿™æ˜¯å¤§å‚é¢è¯•æ‹†è§£â€”â€”é¡¹ç›®å®æˆ˜ç³»åˆ—çš„ç¬¬6ç¯‡æ–‡ç« ï¼Œ â€èµ°æš—è·¯ã€è€•ç˜¦ç”°ã€è¿›çª„é—¨ã€è§å¾®å…‰â€ å‘Šè¯‰æˆ‘ é¢è¯•å…³é”®å°± æ·±å…¥ç†è§£è‡ªå·±é¡¹ç›® è¿™ä¸ªæ‰æ˜¯"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Even</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">é¦–é¡µ</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">å½’æ¡£</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">åˆ†ç±»</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">æ ‡ç­¾</li>
      </a><a href="https://github.com/wangcy6/weekly/tree/master/book">
        <li class="mobile-menu-item">é˜…è¯»æ¸…å•</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">å…³äºæˆ‘</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Even</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">é¦–é¡µ</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">å½’æ¡£</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">åˆ†ç±»</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">æ ‡ç­¾</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://github.com/wangcy6/weekly/tree/master/book">é˜…è¯»æ¸…å•</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">å…³äºæˆ‘</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">IOçš„ä¸€ç”Ÿ</h1>

      <div class="post-meta">
        <span class="post-time"> 2025-04-27 00:00 </span>
        <div class="post-category">
            <a href="/categories/CEPH/"> CEPH </a>
            </div>
          <span class="more-meta"> çº¦ 4262 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 9 åˆ†é’Ÿ </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡é˜…è¯» </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€--å‡†å¤‡ç¯å¢ƒ">ä¸€.  å‡†å¤‡ç¯å¢ƒ</a>
      <ul>
        <li><a href="#11-æœºå™¨é…ç½®">1.1 æœºå™¨é…ç½®</a></li>
        <li><a href="#21-å—è®¾å¤‡ioè·Ÿè¸ª">2.1 å—è®¾å¤‡IOè·Ÿè¸ª</a></li>
        <li><a href="#23ä»å—å±‚é¢-ioä¼˜åŒ–">2.3ä»å—å±‚é¢ IOä¼˜åŒ–</a></li>
      </ul>
    </li>
    <li><a href="#äºŒ--ioæ ˆå…¨æ™¯å›¾">äºŒ.  IOæ ˆå…¨æ™¯å›¾</a></li>
    <li><a href="#ä¸‰ioæ€§èƒ½ä¼˜åŒ–é‡‡ç”¨æ‰‹æ®µ">ä¸‰ã€IOæ€§èƒ½ä¼˜åŒ–é‡‡ç”¨æ‰‹æ®µ</a>
      <ul>
        <li><a href="#å‚è€ƒç¬¬ä¸€æ‰‹èµ„æ–™">å‚è€ƒç¬¬ä¸€æ‰‹èµ„æ–™</a></li>
        <li><a href="#1-introduction-to-perf">[1] Introduction to Perf</a></li>
        <li><a href="#2--etcd-åœ¨è¶…å¤§è§„æ¨¡æ•°æ®åœºæ™¯ä¸‹çš„æ€§èƒ½ä¼˜åŒ–">[2 ] etcd åœ¨è¶…å¤§è§„æ¨¡æ•°æ®åœºæ™¯ä¸‹çš„æ€§èƒ½ä¼˜åŒ–</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>å¤§å®¶å¥½æˆ‘æ˜¯å°ä¹‰åŒå­¦ï¼Œè¿™æ˜¯<!-- raw HTML omitted -->å¤§å‚é¢è¯•æ‹†è§£â€”â€”é¡¹ç›®å®æˆ˜<!-- raw HTML omitted -->ç³»åˆ—çš„ç¬¬<!-- raw HTML omitted -->6<!-- raw HTML omitted -->ç¯‡æ–‡ç« ï¼Œ</p>
<p>â€èµ°æš—è·¯ã€è€•ç˜¦ç”°ã€è¿›çª„é—¨ã€è§å¾®å…‰â€ Â 
å‘Šè¯‰æˆ‘ Â é¢è¯•å…³é”®å°± æ·±å…¥ç†è§£è‡ªå·±é¡¹ç›® è¿™ä¸ªæ‰æ˜¯æœ€è€ƒå¯ŸåŸºæœ¬åŠŸçš„åœ°æ–¹ã€‚</p>
<p>çŸ¥è¯†åœ°å›¾ï¼šKVå­˜å‚¨å¼•æ“&mdash;IOæ ˆ</p>
<p><!-- raw HTML omitted -->æœ¬æ–‡ ä¸»è¦æè¿° read/writeä¸ºä¾‹å­æ™®é€šæ–‡ä»¶ IOè¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ<!-- raw HTML omitted -->ï¼Œ</p>
<p>åˆ†æè¿™ä¸ªé—®é¢˜å…³é”®æ€è·¯åœ¨å“ªé‡Œï¼Ÿ</p>
<p>å¦‚æœæ‚¨è§‰å¾—é˜…è¯»æœ¬æ–‡å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œ
è¯·ç‚¹ä¸€ä¸‹â€œ<strong>ç‚¹èµï¼Œè½¬å‘</strong>â€ æŒ‰é’®ï¼Œ
æ‚¨çš„â€œ<strong>ç‚¹èµï¼Œè½¬å‘</strong>â€ å°†æ˜¯æˆ‘æœ€å¤§çš„å†™ä½œåŠ¨åŠ›ï¼</p>
<p>ä¸Šç¯‡æ–‡ç«  <a href="https://mp.weixin.qq.com/s/iIGui5RywsKC13daAogRJA">æ–°ä¸€ä»£å­˜å‚¨å¼•æ“BlueStore,éœ€å››æ­¥</a></p>
<p>åœ¨åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ—¶å€™ï¼ŒCephçš„BlueStore ï¼Œ</p>
<ol>
<li>å°†æ–‡ä»¶çš„æ•°æ®ç›´æ¥å†™å—è®¾å¤‡</li>
<li>å°†æ–‡ä»¶çš„å…ƒæ•°æ®å†™RocksDB</li>
<li>BlueStore IOæµç¨‹ å…ˆå†™æ•°æ®ï¼Œè¿˜æ˜¯å…ˆå†™å…ƒæ•°æ®é¡ºåºä¸åŒ ï¼Œæä¾›ä¸åŒç­–ç•¥ã€‚</li>
<li>Ceph IO è½¯ä»¶æ ˆå¼€é”€åŸå›  <strong>æ— å®ç°ä½äº 0.5 æ¯«ç§’çš„éšæœºè¯»å–å»¶è¿Ÿå’Œä½äº 1 æ¯«ç§’çš„éšæœºå†™å…¥å»¶è¿Ÿ</strong></li>
</ol>
<p>æ™®é€šæ–‡ä»¶å†™æ˜¯å¦åŒºåˆ†å…ƒæ•°æ® å’Œ æ•°æ®ï¼Œè¿™äº›è¯·æ±‚æœ€åæ€ä¹ˆå†™å…¥ç£ç›˜ å‘¢ï¼Ÿ</p>
<p>å› ä¸ºå†…å®¹å¤ªå¤šï¼Œåˆ†æ‰¹æ¢³ç†ã€‚</p>
<p>å¤§çº²å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆ1ï¼‰ é¢„å¤‡çŸ¥è¯†ï¼š</p>
<p><img src="https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502215215.png" alt="äº†è§£ç›®å‰æœ‰å“ªäº›æ–‡ä»¶ç³»ç»Ÿ"></p>
<p>ï¼ˆ2ï¼‰ é€šè¿‡å·¥å…· äº†è§£IOæ ˆ
<img src="https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502215326.png" alt="IOæ ˆ">
ï¼ˆ3ï¼‰ æ€§èƒ½ä¼˜åŒ–</p>
<p><img src="https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502232459.png" alt="æ€§èƒ½ä¼˜åŒ–"></p>
<h2 id="ä¸€--å‡†å¤‡ç¯å¢ƒ">ä¸€.  å‡†å¤‡ç¯å¢ƒ</h2>
<h3 id="11-æœºå™¨é…ç½®">1.1 æœºå™¨é…ç½®</h3>
<p>âœ… è´­ä¹°2C2Gäº‘ä¸»æœº æˆæœ¬ä¸€å¹´ä¸è¶…è¿‡100å…ƒ</p>
<p>âœ… åˆ›å»º1Gçš„å¤§æ–‡ä»¶å……ä»£æ›¿å—è®¾å¤‡ï¼Œå› ä¸ºæ²¡æœ‰é¢å¤–çš„ç£ç›˜</p>
<p>ğŸ“Œ ä¾‹å­ï¼šç”¨ Loop è®¾å¤‡æ¨¡æ‹Ÿä¸€ä¸ª ext4 æ–‡ä»¶ç³»ç»Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 1. åˆ›å»ºä¸€ä¸ª 1GB çš„æ™®é€šæ–‡ä»¶æ–‡ä»¶</span>

dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/root/temp/virtual_disk.img <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span><span class="m">1024</span>

<span class="c1"># 2. ç»‘å®šåˆ° Loop è®¾å¤‡ï¼ˆè®© Linux è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªç£ç›˜ï¼‰</span>

losetup /dev/loop0 /root/temp/virtual_disk.img

ls -l /dev/loop0

brw-rw---- <span class="m">1</span> root disk 7, <span class="m">0</span> 3æœˆÂ  <span class="m">24</span> 13:51 /dev/loop0ã€‚


b è¡¨ç¤ºå—è®¾å¤‡æ–‡ä»¶ï¼Œ

s è¡¨ç¤ºå¥—æ¥å­— socket æ–‡ä»¶ï¼Œ

l è¡¨ç¤ºç¬¦å·é“¾æ¥

<span class="c1"># 3. åœ¨ /dev/loop0 ä¸Šåˆ›å»º ext4 æ–‡ä»¶ç³»ç»Ÿ</span>

mkfs.ext4 /dev/loop0


<span class="c1"># 4. æŒ‚è½½åˆ° /mnt ç›®å½•</span>

mkdir /mnt/icfs

		mount  /dev/loop0 /mnt/icfs  <span class="c1">#/ordered</span>
		
mount -o nodelallocï¼Œdata<span class="o">=</span>writeback /dev/loop0 /mnt/icfs 


<span class="c1">## æ—¥è®°(journal)ã€ é¡ºåº(ordered)å’Œ å›å†™(writeback)</span>
<span class="c1">##  ext4æŒ‚è½½å‚æ•°ï¼šdelallocExt4æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªæ–°ç‰¹æ€§â€”â€”Delay Allocation ç¦ç”¨</span>

<span class="c1"># 5. å¦‚ä½•æŸ¥çœ‹å½“å‰çš„æ—¥å¿—æ¨¡å¼</span>

<span class="m">5</span> <span class="m">1</span> é€šè¿‡dmesgå‘½ä»¤æŸ¥çœ‹Linuxç³»ç»Ÿçš„å†…æ ¸æ—¥å¿—

dmesg <span class="p">|</span> grepÂ  <span class="s2">&#34;mounted filesystem&#34;</span>
EXT4-fs <span class="o">(</span>vda1<span class="o">)</span>: mounted filesystem with ordered data mode. Opts: <span class="o">(</span>null<span class="o">)</span>


5.2 ç°ç£ç›˜çš„æ°¸ä¹…æŒ‚è½½  å¼€æœºå¯åŠ¨ /etc/fstab file æ£€æŸ¥

 /dev/loop0  /mnt/icfs  ext4 <span class="nv">data</span><span class="o">=</span>writeback <span class="m">0</span> <span class="m">0</span>

5.3  has_journal
 
dumpe2fs /dev/vda1 &gt;1

Filesystem features:Â  Â  Â  
<span class="m">1</span> has_journal 
<span class="m">2</span> ext_attr 
<span class="m">3</span> resize_inode 
<span class="m">4</span> dir_index filetype needs_recovery extent 64bit flex_bg sparse_super large_file huge_file dir_nlink extra_isize metadata_csum


1. æŸ¥çœ‹IOè°ƒåº¦å™¨

cat /sys/block/loop0/queue/scheduler
<span class="o">[</span>mq-deadline<span class="o">]</span> 
kyber 

bfq ï¼š
â€‹ç‰¹æ€§â€‹â€‹ï¼š
æŒ‰è¿›ç¨‹åˆ†é… I/O å¸¦å®½ï¼Œä¿éšœå¤šä»»åŠ¡å…¬å¹³æ€§
å®Œå…¨å…¬å¹³é˜Ÿåˆ—è°ƒåº¦å™¨

none 
ç‰¹æ€§â€‹â€‹ï¼šæ— è°ƒåº¦ç­–ç•¥ï¼Œç›´æ¥ä¼ é€’è¯·æ±‚åˆ°ç¡¬ä»¶å±‚
é€‚ç”¨åœºæ™¯â€‹ï¼šé«˜é€Ÿå­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ NVMe SSDï¼‰æˆ–å·²ç”±å®¿ä¸»æœºç®¡ç† I/O çš„è™šæ‹ŸåŒ–ç¯å¢ƒ

</code></pre></td></tr></table>
</div>
</div><p>åˆ’é‡ç‚¹ï¼šå‚æ•°å«ä¹‰è¯´æ˜</p>
<p>æ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„ä¸‰ç§æ—¥å¿—æ¨¡å¼ æ˜¯ä»€ä¹ˆ</p>
<ul>
<li>ext4æŒ‚è½½å‚æ•°: data</li>
</ul>
<table>
<thead>
<tr>
<th>Journalâ€‹<strong>â€‹ç‰¹æ€§â€‹</strong>â€‹</th>
<th>Journal</th>
<th>Orderedï¼ˆé»˜è®¤ï¼‰</th>
<th>Writeback</th>
</tr>
</thead>
<tbody>
<tr>
<td>â€‹<strong>â€‹æ•°æ®è®°å½•â€‹</strong>â€‹</td>
<td>å…ƒæ•°æ®+æ•°æ®å‡è®°å½•æ—¥å¿—</td>
<td>ä»…å…ƒæ•°æ®æ—¥å¿—</td>
<td>ä»…å…ƒæ•°æ®æ—¥å¿—</td>
</tr>
<tr>
<td>â€‹<strong>â€‹æ•°æ®å†™å…¥é¡ºåºâ€‹</strong>â€‹</td>
<td>ä¸¥æ ¼åŒæ­¥</td>
<td>æ•°æ®å…ˆäºå…ƒæ•°æ®å†™å…¥</td>
<td>æ— å¼ºåˆ¶é¡ºåº</td>
</tr>
<tr>
<td>â€‹<strong>â€‹æ€§èƒ½â€‹</strong>â€‹</td>
<td>æœ€ä½</td>
<td>ä¸­ç­‰</td>
<td>æœ€é«˜</td>
</tr>
<tr>
<td>â€‹<strong>â€‹å´©æºƒæ¢å¤â€‹</strong>â€‹</td>
<td>å®Œå…¨ä¸€è‡´</td>
<td>æ•°æ®å¯èƒ½éƒ¨åˆ†ä¸¢å¤±</td>
<td>æ•°æ®å¯èƒ½å¤§é‡ä¸¢å¤±</td>
</tr>
<tr>
<td>â€‹<strong>â€‹å…¸å‹åœºæ™¯â€‹</strong>â€‹</td>
<td>æ•°æ®åº“ã€å…³é”®ä¸šåŠ¡</td>
<td>æœåŠ¡å™¨ã€æ—¥å¸¸åŠå…¬</td>
<td>é«˜æ€§èƒ½è®¡ç®—</td>
</tr>
</tbody>
</table>
<ul>
<li>IfÂ <code>data=writeback</code>, dirty data blocks are not flushed to the disk before the metadata are written to disk through the journal.</li>
<li>å†…æ ¸æœ‰ä¸“é—¨çš„æœºåˆ¶è´Ÿè´£å°†é¡µç¼“å­˜ä¸­çš„æ•°æ®<strong>å¼‚æ­¥åœ°</strong>å†™å…¥ç£ç›˜ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º<strong>å†™å›ï¼ˆwritebackï¼‰</strong>ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>å»¶è¿Ÿåˆ†é…â€‹<strong>â€‹åœºæ™¯â€‹</strong>â€‹</th>
<th>â€‹<strong>â€‹æ¨èé€‰é¡¹â€‹</strong>â€‹</th>
<th>â€‹<strong>â€‹åŸå› â€‹</strong>â€‹</th>
</tr>
</thead>
<tbody>
<tr>
<td>â€‹<strong>â€‹é«˜ååé‡é¡ºåºå†™å…¥â€‹</strong>â€‹</td>
<td><code>delalloc</code></td>
<td>åˆ©ç”¨æ‰¹é‡åˆ†é…ä¼˜åŒ–è¿ç»­å†™å…¥æ€§èƒ½ï¼ˆå¦‚æ—¥å¿—æœåŠ¡å™¨ã€å¤§æ•°æ®å¤„ç†ï¼‰<!-- raw HTML omitted --><!-- raw HTML omitted --></td>
</tr>
<tr>
<td>â€‹<strong>â€‹ä½å»¶è¿Ÿå…³é”®ä¸šåŠ¡â€‹</strong>â€‹</td>
<td><code>nodelalloc</code></td>
<td>é¿å…å•æ¬¡å†™å…¥å»¶è¿Ÿæ³¢åŠ¨ï¼ˆå¦‚æ•°æ®åº“äº‹åŠ¡ã€å®æ—¶ç³»ç»Ÿï¼‰<!-- raw HTML omitted --></td>
</tr>
</tbody>
</table>
<h3 id="21-å—è®¾å¤‡ioè·Ÿè¸ª">2.1 å—è®¾å¤‡IOè·Ÿè¸ª</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#Â å®‰è£…blktraceåŒ…
</span><span class="cp"></span><span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">blktrace</span>

<span class="cp"># blktraceåŒ…å®‰è£…åæœ‰blktraceã€blkparseã€bttã€blkiomonè¿™4ä¸ªå‘½ä»¤
</span><span class="cp">#blktraceè´Ÿè´£é‡‡é›†I/Oäº‹ä»¶æ•°æ®ï¼Œ
</span><span class="cp"># blkparseè´Ÿè´£å°†æ¯ä¸€ä¸ªI/Oäº‹ä»¶æ•°æ®è§£æä¸ºçº¯æ–‡æœ¬æ–¹ä¾¿é˜…è¯»ï¼Œ
</span><span class="cp">## bttã€blkiomonè´Ÿè´£ç»Ÿè®¡åˆ†æ
</span><span class="cp"></span>
<span class="cp">#Â blktraceä¾èµ–debugfsï¼Œéœ€è¦æŒ‚è½½å®ƒ  
</span><span class="cp"></span><span class="n">sudo</span> <span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">debugfs</span> <span class="n">none</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span>
<span class="cp">## debugfs æ˜¯ Linux å†…æ ¸æä¾›çš„ä¸€ä¸ªä¸“ç”¨æ–‡ä»¶ç³»ç»Ÿï¼ŒåŠ¨æ€åˆ›å»ºã€æ— éœ€é‡æ–°ç¼–è¯‘å†…æ ¸
</span><span class="cp"></span><span class="err">éªŒè¯</span>
<span class="n">ls</span>Â <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span>
<span class="n">mount</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">debugfs</span>Â 

<span class="n">debugfs</span> <span class="n">on</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span> <span class="n">type</span> <span class="n">debugfs</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">)</span>

<span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">zero</span> <span class="n">of</span><span class="o">=/</span><span class="n">mnt</span><span class="o">/</span><span class="n">icfs</span><span class="o">/</span><span class="n">test</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="n">k</span> <span class="n">count</span><span class="o">=</span><span class="mi">16</span>

<span class="n">blktrace</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">loop0</span> <span class="o">-</span><span class="n">o</span> <span class="o">-</span> <span class="o">|</span><span class="n">blkparse</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span>


</code></pre></td></tr></table>
</div>
</div><p>ä¸€ã€å­—æ®µå«ä¹‰ä¸äº‹ä»¶é“¾åˆ†æ</p>
<ol>
<li>â€‹<strong>â€‹å­—æ®µè§£æâ€‹</strong>â€‹ï¼ˆå‚è€ƒç¤ºä¾‹è¡Œï¼š<code>7,0 1 226 52.043115656 3815652 Q WS 1104864 +8 [jbd2/loop0-8]</code>ï¼‰
<ul>
<li>â€‹<strong>â€‹7,0â€‹</strong>â€‹ï¼šè®¾å¤‡å·ï¼ˆä¸»è®¾å¤‡å·:æ¬¡è®¾å¤‡å·ï¼‰ï¼Œè¡¨ç¤ºÂ <code>/dev/loop0</code>ï¼ˆè™šæ‹Ÿå—è®¾å¤‡ï¼‰ã€‚</li>
<li>â€‹<strong>â€‹1â€‹</strong>â€‹ï¼šCPU æ ¸ç¼–å·ï¼ˆæ­¤å¤„ä¸º CPU 1ï¼‰ã€‚</li>
<li>â€‹<strong>â€‹226â€‹</strong>â€‹ï¼šäº‹ä»¶åºåˆ—å·ã€‚</li>
<li>â€‹<strong>â€‹52.043115656â€‹</strong>â€‹ï¼šæ—¶é—´æˆ³ï¼ˆç§’çº§ç²¾åº¦ï¼‰ã€‚</li>
<li>â€‹<strong>â€‹3815652â€‹</strong>â€‹ï¼šè¿›ç¨‹ PIDï¼ˆjbd2 å†…æ ¸çº¿ç¨‹ï¼‰ã€‚</li>
<li>â€‹<strong>â€‹Q/WSâ€‹</strong>â€‹ï¼šäº‹ä»¶ç±»å‹ï¼ˆQ=è¯·æ±‚è¿›å…¥é˜Ÿåˆ—ï¼ŒWS=å†™åŒæ­¥æ“ä½œï¼‰ã€‚</li>
<li>â€‹<strong>â€‹1104864 +8â€‹</strong>â€‹ï¼šèµ·å§‹å—å·Â <code>1104864</code>ï¼Œæ“ä½œå¤§å°Â <code>8</code>Â ä¸ªå—ï¼ˆé€šå¸¸ 1 å—=4KBï¼Œå³ 32KB å†™æ“ä½œï¼‰ã€‚</li>
<li>â€‹<strong>â€‹[jbd2/loop0-8]â€‹</strong>â€‹ï¼šè¿›ç¨‹åï¼Œè¡¨ç¤ºÂ <code>jbd2</code>Â çº¿ç¨‹ç®¡ç†Â <code>/dev/loop0</code>Â è®¾å¤‡çš„æ—¥å¿—åŠŸèƒ½ã€‚</li>
</ul>
</li>
<li>â€‹<strong>â€‹äº‹ä»¶é“¾åˆ†æâ€‹</strong>â€‹ï¼ˆå…³é”®é˜¶æ®µï¼‰
<ul>
<li>â€‹<strong>â€‹Qâ†’G é˜¶æ®µâ€‹</strong>â€‹ï¼ˆè¯·æ±‚ç”Ÿæˆï¼‰ï¼š<br>
ç¤ºä¾‹ï¼š<code>Q WS 1104864 +8</code>Â â†’Â <code>G WS 1104864 +8</code><br>
è¡¨ç¤º I/O è¯·æ±‚è¿›å…¥å—å±‚ååˆ†é…Â <code>request</code>Â ç»“æ„ä½“ï¼ˆè€—æ—¶çº¦å¾®ç§’çº§ï¼‰ã€‚</li>
<li>â€‹<strong>â€‹I é˜¶æ®µâ€‹</strong>â€‹ï¼ˆæ’å…¥è°ƒåº¦å™¨é˜Ÿåˆ—ï¼‰ï¼š<br>
å¤šè¡ŒÂ <code>I WS</code>Â äº‹ä»¶æ˜¾ç¤ºè¯·æ±‚è¢«æ’å…¥ I/O è°ƒåº¦å™¨é˜Ÿåˆ—ï¼ˆå¦‚Â <code>mq-deadline</code>ï¼‰ã€‚</li>
<li>â€‹<strong>â€‹D é˜¶æ®µâ€‹</strong>â€‹ï¼ˆä¸‹å‘åˆ°é©±åŠ¨ï¼‰ï¼š<br>
<code>D WS</code>Â è¡¨ç¤ºè¯·æ±‚è¢«å‘é€è‡³è®¾å¤‡é©±åŠ¨å±‚ï¼Œè¿›å…¥ç‰©ç†è®¾å¤‡å¤„ç†ã€‚</li>
<li>â€‹<strong>â€‹U/FN é˜¶æ®µâ€‹</strong>â€‹ï¼š<br>
<code>U N</code>Â è¡¨ç¤ºé˜Ÿåˆ—è§£ç»‘æ“ä½œï¼›<code>D FN</code>Â å¯èƒ½æ¶‰åŠå±éšœï¼ˆBarrierï¼‰æˆ–åˆ·æ–°æ“ä½œã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">  
jbd2 è¿›ç¨‹è´Ÿè´£ ext4 æ–‡ä»¶ç³»ç»Ÿçš„æ—¥å¿—æäº¤æ“ä½œã€‚

<span class="nb">echo</span> <span class="m">1</span> &gt; /sys/kernel/debug/tracing/events/ext4/ext4_sync_file_enter/enable
<span class="nb">echo</span> <span class="m">1</span> &gt; /sys/kernel/debug/tracing/events/jbd2/jbd2_commit_flushing/enable

Â Â  Â  barad_agent-621691Â  <span class="o">[</span>000<span class="o">]</span> .... 16365334.481433: ext4_sync_file_enter: dev 253,1 ino <span class="m">922856</span> parent <span class="m">927477</span> datasync 1Â 

Â Â  Â  jbd2/vda1-8-367 Â  Â  <span class="o">[</span>000<span class="o">]</span> .... 16365334.482411: jbd2_commit_flushing: dev 253,1 transaction <span class="m">23610801</span> sync <span class="m">0</span>

Â Â  Â  barad_agent-621691Â  <span class="o">[</span>001<span class="o">]</span> .... 16365334.485209: ext4_sync_file_enter: dev 253,1 ino <span class="m">922856</span> parent <span class="m">927477</span> datasync 1Â 

Â Â  Â  barad_agent-621691Â  <span class="o">[</span>001<span class="o">]</span> .... 16365334.485976: ext4_sync_file_enter: dev 253,1 ino <span class="m">923617</span> parent <span class="m">927477</span> datasync 1Â 

Â Â  Â  barad_agent-621691Â  <span class="o">[</span>001<span class="o">]</span> .... 16365334.488730: ext4_sync_file_enter: dev 253,1 ino <span class="m">928166</span> parent <span class="m">927477</span> datasync 1Â 

Â Â  Â  jbd2/vda1-8-367 Â  Â  <span class="o">[</span>001<span class="o">]</span> .... 16365334.489345: jbd2_commit_flushing: dev 253,1 transaction <span class="m">23610802</span> sync <span class="m">0</span>

Â Â  Â  barad_agent-621691Â  <span class="o">[</span>001<span class="o">]</span> .... 16365334.492786: ext4_sync_file_enter: dev 253,1 ino <span class="m">928166</span> parent <span class="m">927477</span> datasync 1Â 

Â Â  Â  barad_agent-621691Â  <span class="o">[</span>001<span class="o">]</span> .... 16365334.493294: ext4_sync_file_enter: dev 253,1 ino <span class="m">923617</span> parent <span class="m">927477</span> datasync 1Â 

Â Â  Â  barad_agent-621691Â  <span class="o">[</span>001<span class="o">]</span> .... 16365334.494829: ext4_sync_file_enter: dev 253,1 ino <span class="m">922856</span> parent <span class="m">927477</span> datasync 1Â 

Â Â  Â  jbd2/vda1-8-367 Â  Â  <span class="o">[</span>000<span class="o">]</span> .... 16365334.495552: jbd2_commit_flushing: dev <span class="m">2</span>


strace -c -f -e <span class="nv">trace</span><span class="o">=</span>file,sync,fsync,fdatasync -p <span class="m">20949</span>

jbd2 çº¿ç¨‹ä¸ Linux é€šç”¨å—å±‚ç´§å¯†åä½œï¼š
ä»æ„é€  BIOã€

è°ƒç”¨ <span class="sb">`</span>submit_bio<span class="o">()</span><span class="sb">`</span>ã€

ä¾èµ–å—å±‚çš„åˆå¹¶ä¸è°ƒåº¦ï¼Œ
åˆ°æ¥æ”¶ <span class="sb">`</span>bio_end_io<span class="sb">`</span> å›è°ƒï¼Œ

å½¢æˆäº†ä¸€ä¸ªç«¯åˆ°ç«¯çš„ã€å…·å¤‡é«˜ä¼˜å…ˆçº§ä¿éšœçš„æ—¥å¿—å†™å…¥é€šé“ï¼Œ
ç¡®ä¿ ext4/ext3 æ–‡ä»¶ç³»ç»Ÿåœ¨å´©æºƒæ¢å¤æ—¶èƒ½å¤Ÿå¿«é€Ÿä¸”å¯é åœ°å›æ”¾ä¸æäº¤äº‹åŠ¡ã€‚

</code></pre></td></tr></table>
</div>
</div><h3 id="23ä»å—å±‚é¢-ioä¼˜åŒ–">2.3ä»å—å±‚é¢ IOä¼˜åŒ–</h3>
<h2 id="äºŒ--ioæ ˆå…¨æ™¯å›¾">äºŒ.  IOæ ˆå…¨æ™¯å›¾</h2>
<ul>
<li><a href="https://www.thomas-krenn.com/de/wikiDE/images/e/e8/Linux-storage-stack-diagram_v6.9.png">https://www.thomas-krenn.com/de/wikiDE/images/e/e8/Linux-storage-stack-diagram_v6.9.png</a></li>
</ul>
<p><img src="https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502165459.png" alt="image.png"></p>
<p>ä¸ºäº†æŒæ¡IOæ ˆå¿…é¡»äº†è§£çš„åŸºæœ¬çŸ¥è¯†</p>
<ul>
<li>ä»€ä¹ˆæ˜¯è™šæ‹Ÿå†…å­˜ï¼Œä¸ç£ç›˜æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ è¿™ä¸ªæ˜¯äº†è§£ å—è®¾å¤‡bioå±‚åŸºç¡€</li>
</ul>
<p><img src="https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502163052.png" alt="â€”ä¸ª VM ç³»ç»Ÿæ˜¯å¦‚ä½•ä½¿ç”¨ä¸»å­˜ä½œä¸ºç¼“å­˜">
å®ƒå°†ä¸»å­˜çœ‹æˆæ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„åœ°å€ç©ºé—´çš„ é«˜é€Ÿç¼“å­˜ï¼Œ
åœ¨ä¸»å­˜ä¸­åªä¿å­˜æ´»åŠ¨åŒºåŸŸï¼Œ
å¹¶æ ¹æ®éœ€è¦åœ¨ç£ç›˜å’Œä¸»å­˜ä¹‹é—´æ¥å›ä¼ é€æ•°æ®ï¼Œ
é€šè¿‡ è¿™ç§æ–¹å¼ï¼Œå®ƒé«˜æ•ˆåœ°ä½¿ç”¨äº†ä¸»å­˜</p>
<p>åœ¨ä»»æ„æ—¶åˆ»ï¼Œè™šæ‹Ÿé¡µé¢çš„é›†åˆéƒ½åˆ†ä¸ºä¸‰ä¸ªä¸ç›¸äº¤çš„å­é›†ï¼š
â€¢æœªåˆ†é…çš„ï¼šVM ç³»ç»Ÿè¿˜æœªåˆ†é…(æˆ–è€…åˆ›å»ºï¼‰çš„é¡µã€‚
æœªåˆ†é…çš„å—æ²¡æœ‰ä»»ä½•æ•°æ®å’Œå®ƒä»¬ç›¸ å…³è”ï¼Œå› æ­¤ä¹Ÿå°±ä¸å ç”¨ä»»ä½•ç£ç›˜ç©ºé—´ã€‚
â€¢ç¼“å­˜çš„ï¼šå½“å‰å·²ç¼“å­˜åœ¨ç‰©ç†å†…å­˜ä¸­çš„å·²åˆ†é…é¡µã€‚
â€¢æœªç¼“å­˜çš„ï¼šæœªç¼“å­˜åœ¨ç‰©ç†å†…å­˜ä¸­çš„å·²åˆ†é…é¡µ</p>
<ul>
<li>
<p>åœ°å€ç©ºé—´ï¼ˆaddress space)æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°åœ°å€çš„æœ‰åºé›†åˆã€åœ°å€å’Œæ•°æ®å…³ç³»ã€‘</p>
</li>
<li>
<p>â€”ä¸ª VM ç³»ç»Ÿæ˜¯å¦‚ä½•ä½¿ç”¨ä¸»å­˜ä½œä¸ºç¼“å­˜</p>
</li>
<li>
<p>åœ¨è™šæ‹Ÿå†…å­˜çš„ä¹ æƒ¯è¯´æ³•ä¸­ï¼ŒDRAM ç¼“å­˜ä¸å‘½ä¸­ç§°ä¸ºç¼ºé¡µï¼ˆpage fault)</p>
</li>
<li>
<p>åœ¨ç£ç›˜å’Œå†…å­˜ä¹‹é—´ä¼ é€é¡µçš„æ´» åŠ¨å«åšäº¤æ¢ï¼ˆswapping)æˆ–è€…é¡µ é¢è°ƒåº¦ï¼ˆpaging)ã€‚é¡µä»ç£ç›˜æ¢å…¥ï¼ˆæˆ–è€…é¡µé¢è°ƒå…¥ï¼‰DRAM å’Œä» DRAM æ¢å‡ºï¼ˆæˆ–è€…é¡µé¢è°ƒå‡ºï¼‰ç£ç›˜ã€‚</p>
</li>
<li>
<p><img src="https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502174539.png" alt="Linux kernel Block I/O Layer"></p>
</li>
</ul>
<h2 id="ä¸‰ioæ€§èƒ½ä¼˜åŒ–é‡‡ç”¨æ‰‹æ®µ">ä¸‰ã€IOæ€§èƒ½ä¼˜åŒ–é‡‡ç”¨æ‰‹æ®µ</h2>
<h3 id="å‚è€ƒç¬¬ä¸€æ‰‹èµ„æ–™">å‚è€ƒç¬¬ä¸€æ‰‹èµ„æ–™</h3>
<h3 id="1-introduction-to-perf">[1] Introduction to Perf</h3>
<ul>
<li><a href="https://www.slideshare.net/slideshow/introduction-to-perf/59077668">https://www.slideshare.net/slideshow/introduction-to-perf/59077668</a></li>
</ul>
<h3 id="2--etcd-åœ¨è¶…å¤§è§„æ¨¡æ•°æ®åœºæ™¯ä¸‹çš„æ€§èƒ½ä¼˜åŒ–">[2 ] etcd åœ¨è¶…å¤§è§„æ¨¡æ•°æ®åœºæ™¯ä¸‹çš„æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li>è‹±æ–‡ï¼šhttps://www.cncf.io/blog/2019/05/09/performance-optimization-of-etcd-in-web-scale-data-scenario/</li>
<li>æ‘˜è¦ï¼šå½“ etcd å­˜å‚¨æ•°æ®é‡è¶…è¿‡ 40GB åï¼Œç»è¿‡ä¸€æ¬¡ compact(compact æ˜¯ etcd å°†ä¸éœ€è¦çš„å†å²ç‰ˆæœ¬æ•°æ®åˆ é™¤çš„æ“ä½œ)åå‘ç° put æ“ä½œçš„å»¶æ—¶æ¿€å¢</li>
<li>etcd å­˜å‚¨å±‚å¯ä»¥çœ‹æˆç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€å±‚åœ¨å†…å­˜ä¸­çš„åŸºäº btree çš„ç´¢å¼•å±‚ï¼Œä¸€å±‚åŸºäº boltdb çš„ç£ç›˜å­˜å‚¨å±‚ã€‚è¿™é‡Œæˆ‘ä»¬é‡ç‚¹ä»‹ç»åº•å±‚ boltdb å±‚ï¼Œå› ä¸ºå’Œæœ¬æ¬¡ä¼˜åŒ–ç›¸å…³</li>
<li><a href="https://www.qiyacloud.cn/2021/10/2021-10-08/">https://www.qiyacloud.cn/2021/10/2021-10-08/</a></li>
<li><a href="https://www.qiyacloud.cn/2021/10/2021-10-21/">https://www.qiyacloud.cn/2021/10/2021-10-21/</a></li>
<li>ç”±ä¸€æ¬¡ slow-request æµ…è°ˆ Ceph scrub åŸç†</li>
<li><a href="https://www.infoq.cn/article/Z9m5xkLYPlp95wyFtksm">https://www.infoq.cn/article/Z9m5xkLYPlp95wyFtksm</a></li>
<li>å¯ä»¥çœ‹åˆ°rocksdbæ­£åœ¨è¿›è¡Œcompactingï¼Œè¯´æ˜ä¸šåŠ¡å†™è¯·æ±‚æ¯”è¾ƒå¤šã€‚
æ‰€ä»¥å¯ç¡®å®šæœ¬æ¬¡slow-requestçš„åŸå› ï¼šå¤§é‡çš„ç”¨æˆ·å†™å…¥æ“ä½œå¯¼è‡´rocksdbè¿›è¡Œcompactingï¼ŒåŠ ä¸Šdeep-scrubè¿›ä¸€æ­¥å¼•å‘åº•å±‚IOèµ„æºçš„ç«äº‰ï¼Œæœ€ç»ˆå¯¼è‡´ç”¨æˆ·è¯·æ±‚è¶…æ—¶</li>
</ul>
<h4 id="3-crush-å¦‚ä½•å®ç°å‡åŒ€åˆ†å¸ƒ">3. <strong>CRUSH å¦‚ä½•å®ç°å‡åŒ€åˆ†å¸ƒ</strong></h4>
<ul>
<li>CRUSH ç®—æ³•èƒ½å¤Ÿå¿«é€Ÿå®šä½å­˜å‚¨è®¾å¤‡å¯¹åº”çš„å¯¹è±¡ï¼Œå¹¶æ ¹æ®è§„åˆ™é€‰æ‹©ä¸€ä¸ªæ–°çš„å­˜å‚¨è®¾å¤‡æ¥å­˜å‚¨å¯¹è±¡ï¼Œå®ç°æ•°æ®çš„è‡ªåŠ¨æ¢å¤å’Œé‡æ–°åˆ†å¸ƒã€‚ä¾‹å¦‚ï¼Œå½“æŸä¸ª OSD å‡ºç°æ•…éšœæ—¶ï¼ŒCRUSH ç®—æ³•ä¼šé‡æ–°è®¡ç®—æ•°æ®çš„å­˜å‚¨ä½ç½®ï¼Œå°†åŸæœ¬å­˜å‚¨åœ¨æ•…éšœ OSD ä¸Šçš„æ•°æ®è¿ç§»åˆ°å…¶ä»–æ­£å¸¸çš„ OSD ä¸Šï¼Œç¡®ä¿æ•°æ®çš„é«˜å¯ç”¨æ€§ã€‚åŒæ—¶ï¼ŒCRUSH ç®—æ³•è¿˜èƒ½å¤Ÿæ ¹æ®é›†ç¾¤çš„è´Ÿè½½æƒ…å†µï¼ŒåŠ¨æ€åœ°è°ƒæ•´æ•°æ®çš„åˆ†å¸ƒï¼Œå®ç°è´Ÿè½½å‡è¡¡ï¼Œæé«˜é›†ç¾¤çš„æ•´ä½“æ€§èƒ½ã€‚</li>
<li><a href="https://www.clyso.com/us/data-distribution-in-ceph-understanding-the-crush-algorithm/">https://www.clyso.com/us/data-distribution-in-ceph-understanding-the-crush-algorithm/</a></li>
<li><a href="https://www.clyso.com/us/pushing-ceph-rados-into-new-frontiers-lets-make-the-linux-of-storage-a-reality/">https://www.clyso.com/us/pushing-ceph-rados-into-new-frontiers-lets-make-the-linux-of-storage-a-reality/</a></li>
<li><strong>æ¡¶ï¼ˆBucketsï¼‰</strong>ï¼š</li>
<li>ç”¨äºè¡¨ç¤ºé›†ç¾¤çš„å±‚çº§ç»“æ„ï¼Œä¾‹å¦‚æ•°æ®ä¸­å¿ƒã€æœºæˆ¿ã€æœºæ¶ã€ä¸»æœºç­‰ã€‚æ¡¶å¯ä»¥åµŒå¥—ï¼Œå½¢æˆæ ‘çŠ¶ç»“æ„ã€‚æ¯ä¸ªæ¡¶åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå­æ¡¶æˆ–è®¾å¤‡ã€‚</li>
<li><a href="https://ceph.com/assets/pdfs/weil-crush-sc06.pdf">https://ceph.com/assets/pdfs/weil-crush-sc06.pdf</a></li>
</ul>
<p>ä¸ä¸€è‡´æ€§å“ˆå¸Œï¼ˆConsistent Hashingï¼‰çš„åŒºåˆ«</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>CRUSH</th>
<th>ä¸€è‡´æ€§å“ˆå¸Œ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ‹“æ‰‘æ„ŸçŸ¥</strong></td>
<td>æ”¯æŒå¤šå±‚çº§æ•…éšœåŸŸï¼ˆæœºæ¶ã€æœºæˆ¿ç­‰ï¼‰ï¼Œç¡®ä¿å‰¯æœ¬åœ¨ä¸åŒåŸŸåˆ†å¸ƒ</td>
<td>é€šå¸¸åªåœ¨é€»è¾‘ç¯ä¸Šåˆ†å¸ƒï¼Œä¸å…³å¿ƒç‰©ç†æ‹“æ‰‘</td>
</tr>
</tbody>
</table>
<h4 id="4-ceph">ã€4ã€‘ ceph</h4>
<ul>
<li>Accelerating Ceph with RDMA and NVMe-oF</li>
<li><a href="https://www.openfabrics.org/images/2018workshop/presentations/206_HTang_AcceleratingCephRDMANVMe-oF.pdf">https://www.openfabrics.org/images/2018workshop/presentations/206_HTang_AcceleratingCephRDMANVMe-oF.pdf</a></li>
<li><a href="https://www.youtube.com/watch?v=Mb816kz27mY">https://www.youtube.com/watch?v=Mb816kz27mY</a>
<ul>
<li><a href="https://ceph.io/en/news/blog/2022/ceph-osd-cpu-scaling/">https://ceph.io/en/news/blog/2022/ceph-osd-cpu-scaling/</a></li>
</ul>
</li>
<li>è‡ªæ—‹é”çš„é«˜æ˜‚æˆæœ¬
åœ¨é«˜ IOPS åœºæ™¯ä¸‹ï¼Œspinlock ä¼šåœ¨çŸ­æ—¶é—´å†…ä¸æ–­å¾ªç¯å°è¯•è·å–é”è€Œä¸è¿›è¡Œä¼‘çœ ï¼Œè¿™ç§â€œå¿™ç­‰â€æ–¹å¼ä¼šå ç”¨å¤§é‡ CPU å‘¨æœŸå´æ— æ³•åšæœ‰æ•ˆå·¥ä½œï¼Œè¡¨ç°ä¸º CPU ä½¿ç”¨ç‡é£™é«˜ä½†ååå¹¶æœªæå‡</li>
<li>AsyncMessenger::AsyncMessenger(</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">
Messenger *ms_cluster = Messenger::create(g_ceph_context, cluster_msg_type,

entity_name_t::OSD(whoami), &#34;cluster&#34;, nonce);

AsyncMessenger::AsyncMessenger(CephContext *cct, entity_name_t name,

const std::string &amp;type, std::string mname, uint64_t _nonce)

: SimplePolicyMessenger(cct, name),

dispatch_queue(cct, this, mname),

nonce(_nonce)

{

std::string transport_type = &#34;posix&#34;;

if (type.find(&#34;rdma&#34;) != std::string::npos)

transport_type = &#34;rdma&#34;;

else if (type.find(&#34;dpdk&#34;) != std::string::npos)

transport_type = &#34;dpdk&#34;


</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<h1 id="bluestore-a-new-faster-storage-backend-for-ceph">BlueStore: a new, faster storage backend for Ceph</h1>
</li>
<li><a href="https://events.static.linuxfound.org/sites/events/files/slides/20170323%20bluestore.pdf">https://events.static.linuxfound.org/sites/events/files/slides/20170323%20bluestore.pdf</a></li>
<li><a href="https://github.com/c-rainstorm/blog/blob/master/os/FileSystem-Ext4.md">https://github.com/c-rainstorm/blog/blob/master/os/FileSystem-Ext4.md</a> è¿™ä¸ªæ–‡ç« æ²¡è¯´journalè®©é™·å…¥è¯¯å¯¼ï¼Œæ³¨æ„åŒºåˆ†</li>
<li><a href="https://events.static.linuxfound.org/sites/events/files/slides/20170323%20bluestore.pdf">https://events.static.linuxfound.org/sites/events/files/slides/20170323%20bluestore.pdf</a> ã€ååé¢å¤šçœ‹å‡ æ¬¡ã€‘
ä¸€ã€â€‹<strong>â€‹æ ¸å¿ƒç—›ç‚¹ï¼šLSM-Treeæ¶æ„çš„å›ºæœ‰ç¼ºé™·â€‹</strong>â€‹
ä¸ç†è§£åœ°æ–¹ï¼šâ— Many deferred write keys end up in L0</li>
</ul>
<ol>
<li>
<p>â€‹<strong>â€‹Compactionä¼˜å…ˆçº§æ§åˆ¶å›°éš¾â€‹</strong>â€‹</p>
<ul>
<li>â€‹<strong>â€‹é—®é¢˜æœ¬è´¨â€‹</strong>â€‹ï¼šRocksDBåŸºäºLSM-Treeï¼ˆLog-Structured Merge Treeï¼‰è®¾è®¡ï¼Œæ•°æ®é€šè¿‡é€å±‚åˆå¹¶ï¼ˆCompactionï¼‰å®ç°æœ‰åºåŒ–ã€‚ä½†â€‹<strong>â€‹ä¸åŒå±‚çº§ï¼ˆL0-Lmaxï¼‰çš„Compactionä¼˜å…ˆçº§æ— æ³•ç²¾ç»†æ§åˆ¶â€‹</strong>â€‹ï¼Œå¯¼è‡´é«˜ä¼˜å…ˆçº§ä¸šåŠ¡æ•°æ®ï¼ˆå¦‚å…ƒæ•°æ®ï¼‰å¯èƒ½è¢«ä½ä¼˜å…ˆçº§æ•°æ®é˜»å¡ã€‚</li>
<li>â€‹<strong>â€‹å…¸å‹æ¡ˆä¾‹â€‹</strong>â€‹ï¼šå…ƒæ•°æ®ï¼ˆå¦‚Bluestoreçš„<code>onode</code>ï¼‰å†™å…¥åé¢‘ç¹è§¦å‘L0â†’L1 Compactionï¼Œè€Œç”¨æˆ·æ•°æ®CompactionæŠ¢å èµ„æºï¼Œå¯¼è‡´å…ƒæ•°æ®è®¿é—®å»¶è¿ŸæŠ–åŠ¨ã€‚</li>
</ul>
</li>
<li>
<p>â€‹<strong>â€‹å…ƒæ•°æ®æ€»é‡å¢é•¿å¼•å‘æ€§èƒ½åŠ£åŒ–â€‹</strong>â€‹</p>
<ul>
<li>â€‹<strong>â€‹é›ªå´©æ•ˆåº”â€‹</strong>â€‹ï¼šéšç€å…ƒæ•°æ®è§„æ¨¡å¢é•¿ï¼ˆå¦‚Cephé›†ç¾¤ä¸­æ•°åäº¿å¯¹è±¡ï¼‰ï¼ŒCompactionæ“ä½œæ‰€éœ€å†…å­˜ã€CPUã€IOèµ„æºå‘ˆéçº¿æ€§ä¸Šå‡ã€‚</li>
<li>â€‹<strong>â€‹æ•°æ®ä½è¯â€‹</strong>â€‹ï¼šå½“å…ƒæ•°æ®æ€»é‡è¶…è¿‡Block Cacheå®¹é‡æ—¶ï¼ŒRange Queryï¼ˆèŒƒå›´æŸ¥è¯¢ï¼‰å› ç¼“å­˜å¤±æ•ˆè¢«è¿«è§¦å‘ç£ç›˜IOï¼Œååé‡ä¸‹é™50%+</li>
<li><a href="https://www.slideshare.net/Inktank_Ceph/ceph-day-shanghai-ceph-performance-tools?from_search=7#">https://www.slideshare.net/Inktank_Ceph/ceph-day-shanghai-ceph-performance-tools?from_search=7#</a> Ceph Day Shanghai - Ceph Performance Tools ã€äº†è§£å‡ ä¸ªå‘½ä»¤ ã€‘</li>
<li><a href="https://www.youtube.com/playlist?list=PLrBUGiINAakNgeLvjald7NcWps_yDCblr">https://www.youtube.com/playlist?list=PLrBUGiINAakNgeLvjald7NcWps_yDCblr</a></li>
</ul>
</li>
</ol>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Troy</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2025-04-27 00:00
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/nusr/blog/blob/master/LICENSE">MIT</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/CEPH/">CEPH</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/habit/02-%E5%91%A8%E5%A4%8D%E7%9B%98/day10-time-/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">2025-å°ç‹åŒå­¦---å†™åœ¨ç™½æ¿ä¸Šçš„2åˆ†é’Ÿï¼šè®©è‡ªæˆ‘æ¿€åŠ±æå‡40%</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/post/storage/2025/2025-05-02-what-is-io/">
            <span class="next-text nav-default">IOçš„ä¸€ç”Ÿ</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="wangcy6/wangcy6.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:wang_cyi@163.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/wangcy6" class="iconfont icon-github" title="github"></a>
  <a href="https://wangcy6.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡ </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> äºº </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2017 - 
    2025
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Troy</span>
  </span>
</div>
<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget/autoload.js"></script>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-cn".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138883536-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
